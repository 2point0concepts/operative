/** Operative v0.0.1 (c) 2013 James padolsey, MIT-licensed, http://github.com/padolsey/operative **/
window.operative=function(){function e(e){var o=this;e.get=e.get||function(e){return this[e]},e.set=e.set||function(e,t){return this[e]=t},this.curToken=0,this.isDestroyed=!1,this.module=e,this.dataProperties={},this.api={},this.callbacks={},t.hasWorkerSupport?this._setupWorker():this._setupFallback();for(var r in e)s.call(e,r)&&this._createExposedMethod(r);return this.api.__operative__=this,this.api.destroy=function(){return o.destroy()},this.api}function t(t){return new e(t)}function o(){"__FUNCTIONS__";self.console={},self.isWorker=!0,["log","debug","error","info","warn","time","timeEnd"].forEach(function(e){self.console[e]=function(){self.postMessage({cmd:"console",method:e,args:[].slice.call(arguments)})}}),self.addEventListener("message",function(e){var t=e.data.definitions;if(t){for(var o in t)self[o]=t[o];return self.setup&&self.setup(),void 0}var r=self[e.data.method].apply(self,e.data.args);self.postMessage({cmd:"result",token:e.data.token,result:r})})}var r=[].slice,s={}.hasOwnProperty,i=window.URL||window.webkitURL,n=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder;return t.hasWorkerSupport=!(!i||!window.Worker||!window.Blob&&!n),e.prototype={_buildWorkerScript:function(){var e,t=[],r=this.module,s=this.dataProperties;for(var i in r){var e=r[i];"function"==typeof e?t.push('	self["'+i.replace(/"/g,'\\"')+'"] = '+(""+e)+";"):s[i]=e}return"("+(""+o).replace('"__FUNCTIONS__"',t.join("\n"))+"());"},_onWorkerMessage:function(e){var t=e.data;switch(t.cmd){case"console":window.console&&window.console[t.method].apply(window.console,t.args);break;case"result":if(!(t.token in this.callbacks))throw Error("Operative: Unmatched token: "+t.token);var o=this.callbacks[t.token];delete this.callbacks[t.token],o(t.result)}},_setupWorker:function(){var e,t=this,o=this._buildWorkerScript();try{e=new Blob([o],{type:"text/javascript"})}catch(r){e=new n,e.append(o),e=e.getBlob()}var s=this.worker=new Worker(i.createObjectURL(e));s.addEventListener("message",function(e){t._onWorkerMessage(e)}),s.postMessage({definitions:this.dataProperties})},_createExposedMethod:function(e){var o=this;this.api[e]=function(){if(o.isDestroyed)throw Error("Operative: Cannot run method. Operative has already been destroyed");var s=++o.curToken,i=r.call(arguments),n=i.pop();if("function"!=typeof n)throw new TypeError("Operative: Expected last argument to be Function (callback)");t.hasWorkerSupport?(o.worker.postMessage({method:e,args:i,token:s}),o.callbacks[s]=n):setTimeout(function(){n(o.module[e].apply(o.module,i))},1)}},_setupFallback:function(){this.module.isWorker=!1,this.module.setup&&this.module.setup()},destroy:function(){this.isDestroyed=!0,this.worker&&this.worker.terminate()}},t.Operative=e,t}();