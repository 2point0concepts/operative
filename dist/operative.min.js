/** Operative v0.2.0 (c) 2013 James padolsey, MIT-licensed, http://github.com/padolsey/operative **/
(function(){function makeBlobURI(e){var r;try{r=new Blob([e],{type:"text/javascript"})}catch(t){r=new BlobBuilder,r.append(e),r=r.getBlob()}return URL.createObjectURL(r)}function Operative(e){var r=this;e.get=e.get||function(e){return this[e]},e.set=e.set||function(e,r){return this[e]=r},this._curToken=0,this._queue=[],this.isDestroyed=!1,this.isContextReady=!1,this.module=e,this.dataProperties={},this.api={},this.callbacks={},this.deferreds={},this._setup();for(var t in e)hasOwn.call(e,t)&&this._createExposedMethod(t);this.api.__operative__=this,this.api.destroy=function(){return r.destroy()}}function operative(e){var r=operative.hasWorkerSupport?Operative.Worker:Operative.Iframe;if("function"==typeof e){var t=new r({main:e});return function(){return t.api.main.apply(t,arguments)}}return new r(e).api}function iframeBoilerScript(){window.__run__=function(e,r,t,o){var i=!1,s=!1;window.async=function(){return i=!0,t},window.deferred=function(){return s=!0,o},t&&r.push(t);var n=window[e].apply(window,r);window.async=function(){throw Error("Operative: async() called at odd time")},window.deferred=function(){throw Error("Operative: deferred() called at odd time")},s||i||void 0===n||t(n)}}function workerBoilerScript(){var postMessage=self.postMessage,objectTransferSupport=null;self.console={},self.isWorker=!0,["log","debug","error","info","warn","time","timeEnd"].forEach(function(e){self.console[e]=function(){postMessage({cmd:"console",method:e,args:[].slice.call(arguments)})}}),self.addEventListener("message",function(e){function returnResult(e){postMessage({cmd:"result",token:data.token,result:e}),returnResult=function(){throw Error("Operative: You have already returned.")}}var data=e.data;if("string"==typeof data&&0===data.indexOf("EVAL|"))return eval(data.substring(5)),void 0;if(null==objectTransferSupport)return objectTransferSupport="PING"===e.data[0],self.postMessage(objectTransferSupport?"pingback:objectTransferSupport=YES":"pingback:objectTransferSupport=NO"),objectTransferSupport||(postMessage=function(e){return self.postMessage(JSON.stringify(e))}),void 0;objectTransferSupport||(data=JSON.parse(data));var defs=data.definitions,isDeferred=!1,isAsync=!1,args=data.args;if(defs)for(var i in defs)self[i]=defs[i];else{args.push(function(){returnResult({args:[].slice.call(arguments)})}),self.async=function(){return isAsync=!0,function(){returnResult({args:[].slice.call(arguments)})}},self.deferred=function(){function e(e){return returnResult({isDeferred:!0,action:"fulfill",args:[e]}),t}function r(e){returnResult({isDeferred:!0,action:"reject",args:[e]})}isDeferred=!0;var t={};return t.fulfil=t.fulfill=e,t.reject=r,t};var result=self[data.method].apply(self,args);isDeferred||isAsync||void 0===result||returnResult({args:[result]}),self.deferred=function(){throw Error("Operative: deferred() called at odd time")},self.async=function(){throw Error("Operative: async() called at odd time")}}})}if("undefined"==typeof window&&self.importScripts)return workerBoilerScript(),void 0;var slice=[].slice,hasOwn={}.hasOwnProperty,scripts=document.getElementsByTagName("script"),opScript=scripts[scripts.length-1],opScriptURL=/operative/.test(opScript.src)&&opScript.src,URL=window.URL||window.webkitURL,BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,workerViaBlobSupport=function(){try{new Worker(makeBlobURI(";"))}catch(e){return!1}return!0}(),objCreate=Object.create||function(e){function r(){}return r.prototype=e,new r};operative.hasWorkerSupport=!!window.Worker,operative.Promise=window.Promise,"undefined"!=typeof module&&module.exports?module.exports=operative:window.operative=operative,operative.setSelfURL=function(e){opScriptURL=e},Operative.prototype={_marshal:function(e){return e},_demarshal:function(e){return e},_enqueue:function(e){this._queue.push(e)},_dequeueAll:function(){for(var e=0,r=this._queue.length;r>e;++e)this._queue[e].call(this);this._queue=[]},_buildContextScript:function(e){var r,t=[],o=this.module,i=this.dataProperties;for(var s in o){var r=o[s];"function"==typeof r?t.push('   self["'+s.replace(/"/g,'\\"')+'"] = '+(""+r)+";"):i[s]=r}return t.join("\n")+(e?"\n("+(""+e)+"());":"")},_createExposedMethod:function(e){var r=this;this.api[e]=function(){function t(){r.isContextReady?r._runMethod(e,o,i):r._enqueue(t)}if(r.isDestroyed)throw Error("Operative: Cannot run method. Operative has already been destroyed");var o=++r._curToken,i=slice.call(arguments),s="function"==typeof i[i.length-1]&&i.pop();if(!s&&!operative.Promise)throw Error("Operative: No callback has been passed. Assumed that you want a promise. But `operative.Promise` is null. Please provide Promise polyfill/lib.");if(s)r.callbacks[o]=s,setTimeout(function(){t()},1);else if(operative.Promise)return new operative.Promise(function(e){e.fulfil=e.fulfill,r.deferreds[o]=e,t()})}},destroy:function(){this.isDestroyed=!0}},Operative.Worker=function Worker(){this._msgQueue=[],Operative.apply(this,arguments)};var WorkerProto=Operative.Worker.prototype=objCreate(Operative.prototype);WorkerProto._onWorkerMessage=function(e){var r=e.data;if("string"==typeof r&&0===r.indexOf("pingback"))return"pingback:objectTransferSupport=NO"===r&&(this._marshal=function(e){return JSON.stringify(e)},this._demarshal=function(e){return JSON.parse(e)}),this.isContextReady=!0,this._dequeueAll(),void 0;switch(r=this._demarshal(r),r.cmd){case"console":window.console&&window.console[r.method].apply(window.console,r.args);break;case"result":var t=this.callbacks[r.token],o=this.deferreds[r.token];delete this.callbacks[r.token],delete this.deferreds[r.token];var i=r.result&&r.result.isDeferred&&r.result.action;o&&i?o[i](r.result.args[0]):t&&t.apply(this,r.result.args)}},WorkerProto._setup=function(){var e,r=this,t=this._buildContextScript(workerBoilerScript);if(this.dependencies&&(t='importScripts("'+this.dependencies.join('", "')+'");\n'+t),workerViaBlobSupport)e=this.worker=new Worker(makeBlobURI(t));else{if(!opScriptURL)throw Error("Operaritve: No operative.js URL available. Please set via operative.setSelfURL(...)");e=this.worker=new Worker(opScriptURL),e.postMessage("EVAL|"+this._buildWorkerScript(null))}e.postMessage(["PING"]),e.addEventListener("message",function(e){r._onWorkerMessage(e)}),this._postMessage({definitions:this.dataProperties})},WorkerProto._postMessage=function(e){return this.worker.postMessage(this._marshal(e))},WorkerProto._runMethod=function(e,r,t){this._postMessage({method:e,args:t,token:r})},WorkerProto.destroy=function(){this.worker.terminate(),Operative.prototype.destroy.call(this)},Operative.Iframe=function Iframe(){Operative.apply(this,arguments)};var IframeProto=Operative.Iframe.prototype=objCreate(Operative.prototype);IframeProto._setup=function(){var e=this;this.module.isWorker=!1;var r=this.iframe=document.body.appendChild(document.createElement("iframe"));r.style.display="none";var t=this.iframeWindow=r.contentWindow,o=t.document;o.open(),o.close();var i=o.createElement("script"),s=e._buildContextScript(iframeBoilerScript);void 0!==i.text?i.text=s:i.innerHTML=s,o.documentElement.appendChild(i);for(var n in e.dataProperties)t[n]=e.dataProperties[n];e.isContextReady=!0,e._dequeueAll()},IframeProto._runMethod=function(e,r,t){var o=this,i=this.callbacks[r],s=this.deferreds[r];delete this.callbacks[r],delete this.deferreds[r],this.iframeWindow.__run__(e,t,function(){var e=i;if(!e)throw Error("Operative: You have already returned.");i=null,e.apply(o,arguments)},s)},IframeProto.destroy=function(){this.iframe.parentNode.removeChild(this.iframe),Operative.prototype.destroy.call(this)},operative.Operative=Operative})();